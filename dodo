#!/usr/bin/env python3
# -*- coding: utf8 -*-

from __future__ import annotations
import os
import sys
import logging
import time
from asserttool import ic
from decimal import Decimal
import hs
logging.basicConfig(level=logging.INFO)

if len(sys.argv) < 3:
    print(sys.argv[0], '<interval_in_seconds>', '<count>', 'command', file=sys.stderr)
    sys.exit(1)

ignore_exit_code = False
if os.path.basename(sys.argv[0]) == "dodo-force":
    ignore_exit_code = True

delay = Decimal(sys.argv[1])
count = Decimal(sys.argv[2])

i = 0
while True:
    i += 1
    _program = sys.argv[3]
    ic(_program)
    _program_path = hs.Command("which")(_program).strip()
    ic(_program_path)

    _command = hs.Command(_program_path)
    for _arg in sys.argv[4:]:
        _command.bake(_arg)

    if ignore_exit_code:
        _command(_fg=True, _ok_code=list(range(256)))
    else:
        _command(_fg=True)
    time.sleep(float(delay))
    if i == count:
        break
